{{ $content := .Content }}
{{ $raw := .RawContent }}
{{ $page := .Page }}

{{/* Escape slashes for Latex to fix line breaks */}}
{{$latex := findRE "(?:\\${2}([^\\$]+)\\${2})|(?:\\$([^\\$]*)\\$)" $content}}
{{range $latex}}
  {{$fixed := replaceRE "\\\\(?: +|\\n)" "\\\\ " .}}
  {{$content = replace $content . $fixed}}
{{end}}

{{/* Wikilinks */}}
{{$wikilinks := $content | findRE "!?\\[\\[\\S[^\\[\\]\\|]*(?:\\|[^\\[\\]]*)?\\S\\]\\]" }}
{{$codefences := $raw | findRE "\\x60[^\\x60\\n]+\\x60"}}
{{$codeblocks := $raw | findRE "\\x60{3}[^\\x60]+\\x60{3}"}}
{{$code := union $codefences $codeblocks}}

{{range $wikilinks}}
  {{$cur := .}}
  {{$incode := false}}
  {{range $code}}
    {{if (in . $cur)}}
      {{$incode = true}}
    {{end}}
  {{end}}

  {{if not $incode}}

    <!-- remove link delimiters -->
    {{$inner := . | strings.TrimPrefix "!" | strings.TrimPrefix "[[" | strings.TrimSuffix "]]" }}
    <!-- split from alias -->
    {{$split := split $inner "|"}}
    <!-- separate link path -->
    {{$path := index $split 0}}

    {{$reference := split $path "#"}}
    <!-- path with heading link removed -->
    {{$title := index $reference 0}}
    <!-- $display is hyperlink display text -->
    <!-- use alias, else title -->
    {{$display := default $title (index $split 1)}}
    <!-- remove subfolder from title -->
    {{$display := index (last 1 (split $display "/")) 0}}

    {{$relpath := relURL $path}} 

    {{$splitpath := split $relpath "/"}}

    {{$modpath := slice}}
    {{range $val := $splitpath}}
        {{ $val = $val | urlquery | replaceRE "\\+" "%20"}}
        {{ $modpath = $modpath | append $val}}
    {{end}}

    <!-- attempt to get title -->
    {{$searchtitle := $title }}
    {{$curpage := $page.GetPage $searchtitle }}
    <!-- attempt to search md file instead  -->
    {{ if (eq $curpage.String "nopPage") }}
      {{$searchtitle = (add $title ".md") }}
      {{$curpage = $page.GetPage $searchtitle }}
    {{ end }}
    <!-- attempt to reverse typographer behaviour  -->
    {{ if (eq $curpage.String "nopPage") }}
      {{$searchtitle = (replace $searchtitle "&amp;" "&") }}
      {{$searchtitle = (replace $searchtitle "&quot;" "\"") }}
      {{$searchtitle = (replace $searchtitle "&rdquo;" "\"") }}
      {{$searchtitle = (replace $searchtitle "&ldquo;" "\"") }}
      {{$searchtitle = (replace $searchtitle "&rsquo;" "'") }}
      {{$searchtitle = (replace $searchtitle "&lsquo;" "'") }}
      {{$curpage = $page.GetPage $searchtitle }}
    {{ end }}  

    <!-- If path to Hugo page -->
    {{if not (eq $curpage.String "nopPage") }}
      {{$block := default "" (index $reference 1)}}
      {{$block = strings.TrimRight "/" (cond (eq $block "") $block (printf "#%s" $block)) | urlize | lower}}
      {{$href := strings.TrimRight "/" $curpage.RelPermalink}}
      {{$link := printf "<a href=\"%s%s\" rel=\"noopener\" class=\"internal-link\" data-src=\"%s\">%s</a>" $href $block $href $display}}
      {{$content = replace $content . $link}}
    <!-- If path to existing file -->
    {{else if fileExists $path}}
      {{$filename := index (last 1 $splitpath) 0}}
      {{$href := path.Join $modpath}}
      {{$href = printf "/%s" $href}}

      <!-- Embedded? -->
      {{if (hasPrefix . "!")}}
        {{ $embed_ext := lower (path.Ext $href) }}
        <!-- Image -->
        {{if in ".png .jpg .jpeg .gif .bmp .svg" $embed_ext }}
          {{$width := default "auto" (index $split 1) }}
          {{$link := printf "<img src=\"%s\" width=\"%s\"/>" $href $width}}
          {{$content = replace $content . $link}}
        <!-- Video -->
        {{else if in ".mp4 .webm .ogv .mov .mkv" $embed_ext}}
          {{$link := printf "<video src=\"%s\" style=\"width: -webkit-fill-available;\" controls></video>" $href}}
          {{$content = replace $content . $link}}
        <!-- Audio -->
        {{else if in ".mp3 .webm .wav .m4a .ogg .3gp .flac" $embed_ext}}
          {{$link := printf "<audio src=\"%s\" controls></audio>" $href}}
          {{$content = replace $content . $link}}
        <!-- PDF -->
        {{else if in ".pdf" $embed_ext }}
          {{$src_link := printf "<a href=\"%s\" rel=\"noopener\" class=\"internal-link\">%s</a>" $href $filename}}
          {{$iframe_link := printf "<iframe src=\"%s#view=fit\" style=\"height: -webkit-fill-available; width: -webkit-fill-available;\"></iframe>" $href}}
          {{$link := printf "%s<br>%s" $src_link $iframe_link}}
          {{$content = replace $content . $link}}
        <!-- other -->
        {{else}}
          {{$link := printf "<a href=\"%s\" rel=\"noopener\" class=\"internal-link\">%s</a>" $href $href}}
          {{$content = replace $content . $link}}
        {{end}}
      {{else}}
        {{$link := printf "<a href=\"%s\" rel=\"noopener\" class=\"internal-link\">%s</a>" $href $display}}
        {{$content = replace $content . $link}}
      {{end}}
    <!-- Broken path -->
    {{else}}
      {{$link := printf "<a class=\"internal-link broken\">%s</a>" $display}}
      {{$content = replace $content . $link}}
    {{end}}

  {{end}}
{{end}}

{{/* Add jumpable anchors */}}
{{ $content = $content | replaceRE "(<h[1-9] id=\"([^\"]+)\">)(.+)(</h[1-9]>)" `<a href="#${2}">${1}<span class="hanchor" ariaLabel="Anchor"># </span>${3}${4}</a>` }}

{{/* Callouts */}}
{{if $.Site.Data.config.enableCallouts}}
  {{ $content = $content | replaceRE "<blockquote>" "<blockquote class=callout>" }}
  {{ $blockquoteclasses := findRE `\[!.+\]` $content }}
  {{ $blockquoteclasses1 := findRE "<blockquote.*?>(.|\n)*?</blockquote>" $content }}
  {{ $blockquotetags := findRE `blockquote class=callout` $content }}
  {{ $counter := 0 }}
  {{ $counter1 := 0 }}
  {{ $finder := index $blockquoteclasses1 $counter }}
  {{range $blockquotetags}}
    {{ $finder = index $blockquoteclasses1 $counter }}
    {{ if (in $finder "[!") }}
      {{ $inner := index $blockquoteclasses $counter1 }}
      {{ if (in $finder "]-") }}
        {{ $inner = $inner | replaceRE `\[!([a-zA-Z]+)\]` `callout-collapsible callout-collapsed ${1}`}}
      {{ else if (in $finder "]+") }}
        {{ $inner = $inner | replaceRE `\[!([a-zA-Z]+)\]` `callout-collapsible ${1}`}}
      {{ else}}
        {{ $inner = $inner | replaceRE `\[!([a-zA-Z]+)\]` `${1}` }}
      {{ end }}
      {{ $inner = printf "blockquote class=\"%s-callout\"" $inner | lower}}
      {{ $content = replace $content . $inner 1}}
      {{ $counter1 = add $counter1 1 }}
    {{ else }}
      {{ $inner := print "blockquote" }}
      {{ $content = replace $content . $inner 1}}
    {{ end }}
    {{ $counter = add $counter 1 }}
  {{end}}
  {{ $content = $content | replaceRE `\[![a-zA-Z]+\][-\+]?` "" }}
  {{ $content = $content | replaceRE "blockquote class=callout" "blockquote" }}
  {{ $content = $content | replaceRE `(?s)(<blockquote class=".*?\s?\S+-callout.*?">.*?)<br>(.*?<\/blockquote>)` `${1}</p><p>${2}` }}

  {{ $c_types := findRE `(?s)<blockquote class=".*?\s?(\S+)-callout.*?">` $content }}
  {{ range $c_type := $c_types }}
    {{ $c_type = $c_type | replaceRE `.*?\s?(\S+)-callout.*?` `${1}` }}
    {{ $c_type }}
    {{ $icon := "" }}
    {{ if or (eq $c_type "summary") (eq $c_type "abstract") (eq $c_type "tldr") }}
      {{ $icon = "<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='lucide lucide-clipboard-list'><rect width='8' height='4' x='8' y='2' rx='1' ry='1'></rect><path d='M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2'></path><path d='M12 11h4'></path><path d='M12 16h4'></path><path d='M8 11h.01'></path><path d='M8 16h.01'></path></svg>" }}
    {{ else if eq $c_type "bug" }}
      {{ $icon = "<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='lucide lucide-bug'><rect width='8' height='14' x='8' y='6' rx='4'/><path d='m19 7-3 2'/><path d='m5 7 3 2'/><path d='m19 19-3-2'/><path d='m5 19 3-2'/><path d='M20 13h-4'/><path d='M4 13h4'/><path d='m10 4 1 2'/><path d='m14 4-1 2'/></svg>" }}
    {{ else if or (eq $c_type "danger") (eq $c_type "error") }}
      {{ $icon = "<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='lucide lucide-bug'><rect width='8' height='14' x='8' y='6' rx='4'/><path d='m19 7-3 2'/><path d='m5 7 3 2'/><path d='m19 19-3-2'/><path d='m5 19 3-2'/><path d='M20 13h-4'/><path d='M4 13h4'/><path d='m10 4 1 2'/><path d='m14 4-1 2'/></svg>" }}
    {{ else if eq $c_type "example" }}
      {{ $icon = "<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='lucide lucide-list'><line x1='8' x2='21' y1='6' y2='6'/><line x1='8' x2='21' y1='12' y2='12'/><line x1='8' x2='21' y1='18' y2='18'/><line x1='3' x2='3.01' y1='6' y2='6'/><line x1='3' x2='3.01' y1='12' y2='12'/><line x1='3' x2='3.01' y1='18' y2='18'/></svg>" }}
    {{ else if or (eq $c_type "fail") (eq $c_type "failure") (eq $c_type "missing") }}
      {{ $icon =  "<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='lucide lucide-x'><path d='M18 6 6 18'/><path d='m6 6 12 12'/></svg>" }}
    {{ else if eq $c_type "info" }}
      {{ $icon = "<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='lucide lucide-info'><circle cx='12' cy='12' r='10'/><path d='M12 16v-4'/><path d='M12 8h.01'/></svg>" }}
    {{ else if eq $c_type "todo" }}
      {{ $icon = "<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='lucide lucide-check-circle-2'><path d='M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z'/><path d='m9 12 2 2 4-4'/></svg>" }}
    {{ else if eq $c_type "note" }}
      {{ $icon = "<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='svg-icon lucide-pencil'><line x1='18' y1='2' x2='22' y2='6'/><path d='M7.5 20.5 19 9l-4-4L3.5 16.5 2 22z'/></svg>" }}
    {{ else if or (eq $c_type "question") (eq $c_type "help") (eq $c_type "faq") }}
      {{ $icon = "<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='lucide lucide-help-circle'><circle cx='12' cy='12' r='10'/><path d='M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3'/><path d='M12 17h.01'/></svg>" }}
    {{ else if or (eq $c_type "quote") (eq $c_type "cite") }}
      {{ $icon = "<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='lucide lucide-quote'><path d='M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z'/><path d='M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2h.75c0 2.25.25 4-2.75 4v3c0 1 0 1 1 1z'/></svg>" }}
    {{ else if or (eq $c_type "success") (eq $c_type "done") (eq $c_type "check") }}
      {{ $icon = "<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='lucide lucide-check'><polyline points='20 6 9 17 4 12'/></svg>" }}
    {{ else if or (eq $c_type "important") (eq $c_type "tip") (eq $c_type "hint") }}
      {{ $icon = "<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='lucide lucide-flame'><path d='M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z'/></svg>" }}
    {{ else if or (eq $c_type "warning") (eq $c_type "caution") (eq $c_type "attention") }}
      {{ $icon = "<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='lucide lucide-alert-triangle'><path d='m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z'/><path d='M12 9v4'/><path d='M12 17h.01'/></svg>" }}
    {{ else if or (eq $c_type "media") (eq $c_type "video") (eq $c_type "audio") (eq $c_type "recording") }}
      {{ $icon = "<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='lucide lucide-play'><polygon points='5 3 19 12 5 21 5 3'/></svg>" }}
    {{ else if or (eq $c_type "resource") (eq $c_type "document") (eq $c_type "attachment") (eq $c_type "file") }}
      {{ $icon = "<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='lucide lucide-package'><path d='M16.5 9.4 7.55 4.24'/><path d='M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z'/><polyline points='3.29 7 12 12 20.71 7'/><line x1='12' x2='12' y1='22' y2='12'/></svg>" }}
    {{ end }}
    {{ $content = $content | replaceRE (printf `(?s)(<blockquote class=".*?\s?%s-callout.*?">)\s*<p>(.*?)<\/p>(.*?)<\/blockquote>` $c_type) (printf `${1}<div class="callout-title"><div class="callout-icon">%s</div><div class="callout-title-inner">${2}</div></div><div class="callout-content">${3}</div></blockquote>` $icon) }}
  {{ end }}
  {{ $content = $content | replaceRE `(?s)(<blockquote class="callout-collapsible.*?">.*?<div class="callout-title">.*?<div class="callout-title-inner">.*?<\/div>)(<\/div>.*?<\/blockquote>)` `${1}<div class="callout-fold"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg></div>${2}` }}
  {{ $content = $content | replaceRE `(?s)<div class="callout-content"><\/div>` "" }}
{{end}}

{{/* Make ==text== into <mark>text</mark> */}}
{{$mark := findRE "==([^=\n]+)==" $content}}
{{range $mark}}
  {{$fixed := printf "<mark>%s</mark>" (replace . "==" "")}}
  {{$content = replace $content . $fixed}}
{{end}}

{{ $content := $content | replaceRE `(?s)<p>\s*(.*?)\s*<\/p>` `<p>${1}</p>` }}
    
{{/* $content | safeHTML */}}
